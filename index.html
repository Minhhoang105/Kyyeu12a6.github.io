<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·ª∑ Y·∫øu L·ªõp V13 - T√¨m Ki·∫øm Th√¥ng Minh + Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- 1. C·∫§U H√åNH GIAO DI·ªÜN --- */
        :root {
            --bg-fallback: #F9F1F0; 
            --accent: #D4A59A;         
            --accent-dark: #8E6C65;    
            --text: #5E4B45;
            --card: rgba(255, 255, 255, 0.9);
            --shadow-soft: 0 10px 30px rgba(142, 108, 101, 0.1);
            --shadow-deep: 0 20px 50px rgba(142, 108, 101, 0.25);
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg-fallback);
            background-position: center; background-size: cover; background-attachment: fixed;
            color: var(--text); font-family: 'Quicksand', sans-serif;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; margin: 0;
            transition: background-image 0.8s ease-in-out;
        }

        /* Animation */
        .animate-up {
            animation: fadeUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0; transform: translateY(30px);
        }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        .overlay-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); 
            z-index: -1; pointer-events: none;
        }

        /* --- 2. HEADER --- */
        header { 
            text-align: center; margin-top: 60px; width: 100%; max-width: 1200px; 
            position: relative; z-index: 10; padding: 0 20px;
        }
        
        h1 { 
            font-family: 'Cinzel', serif; font-size: 3.5rem; margin: 0; letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(45deg, #5E4B45 0%, #D4A59A 50%, #5E4B45 100%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        
        .bg-btn {
            margin-top: 15px; padding: 10px 25px; background: rgba(255,255,255,0.8);
            border: 1px solid var(--accent); border-radius: 30px;
            color: var(--accent-dark); font-weight: 600; cursor: pointer;
            display: none; box-shadow: var(--shadow-soft);
        }
        body.is-admin .bg-btn { display: inline-block; }

        .class-frame {
            width: 100%; height: 450px; background: #fff;
            border-radius: 20px; margin-top: 40px;
            box-shadow: var(--shadow-deep); position: relative; overflow: hidden;
            border: 8px solid rgba(255,255,255,0.6);
        }
        .class-frame img { width: 100%; height: 100%; object-fit: cover; transition: 1s; }
        .class-frame:hover img { transform: scale(1.05); }

        /* --- 3. MEMORIES SECTION --- */
        .memories-grid {
            width: 100%; max-width: 1200px; margin: 60px 0 40px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 50px; padding: 0 20px;
        }
        .polaroids { display: flex; justify-content: center; gap: 10px; }
        .polaroid {
            background: #fff; padding: 10px 10px 40px 10px;
            box-shadow: var(--shadow-soft); transition: 0.4s;
            transform: rotate(-5deg); width: 33%; position: relative;
        }
        .polaroid:nth-child(2) { transform: rotate(3deg) translateY(-20px); z-index: 2; }
        .polaroid:nth-child(3) { transform: rotate(-2deg); }
        .polaroid:hover { transform: scale(1.1) rotate(0deg); z-index: 10; box-shadow: var(--shadow-deep); }
        .polaroid img { width: 100%; height: 180px; object-fit: cover; }

        .notes-col { display: flex; flex-direction: column; gap: 20px; justify-content: center; }
        .note {
            background: rgba(255, 253, 240, 0.9); padding: 20px;
            border-left: 4px solid var(--accent); border-radius: 0 10px 10px 0;
            box-shadow: var(--shadow-soft); font-style: italic; color: #666;
            transition: 0.3s;
        }
        .note:hover { transform: translateX(10px); background: #fff; }

        /* --- CHAT SECTION (M·ªöI) --- */
        .chat-section {
            width: 100%; max-width: 900px; margin: 20px auto; padding: 12px; border-radius: 12px;
            background: var(--card); box-shadow: var(--shadow-soft); display:flex; gap:12px; align-items:flex-end;
        }
        .chat-window { flex:1; display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding:10px; border-radius:10px; background: rgba(255,255,255,0.6); }
        .chat-inputs { width:320px; display:flex; flex-direction:column; gap:8px; }
        .chat-input { padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); min-height:38px; resize:none; }
        .send-btn { padding:10px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer }
        .message { max-width:75%; padding:8px 12px; border-radius:12px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
        .message.me { background: linear-gradient(90deg,#dfe9f3,#fff); margin-left:auto; }
        .meta { font-size:12px;color:#888;margin-bottom:4px; }
        .chat-header { display:flex;align-items:center;justify-content:space-between;padding:6px 8px; border-bottom:1px dashed rgba(0,0,0,0.06); margin-bottom:6px }

        /* --- 4. THANH T√åM KI·∫æM (NEW) --- */
        .search-bar-container {
            width: 100%; max-width: 600px; margin: 0 auto 40px; padding: 0 20px;
            position: relative; z-index: 20;
        }
        .search-input {
            width: 100%; padding: 15px 25px; border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.9);
            font-family: 'Quicksand', sans-serif; font-size: 1.1rem; color: var(--text);
            box-shadow: var(--shadow-soft); transition: 0.3s;
        }
        .search-input:focus {
            border-color: var(--accent); box-shadow: var(--shadow-deep); transform: scale(1.02);
        }
        .search-input::placeholder { color: #aaa; }

        /* --- 5. DANH S√ÅCH H·ªåC SINH --- */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 30px; width: 100%; max-width: 1200px; padding: 20px; margin-bottom: 100px;
        }

        .card {
            background: var(--card); border-radius: 20px; padding: 25px;
            box-shadow: var(--shadow-soft); position: relative;
            border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(5px);
            cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .card:hover { transform: translateY(-15px); box-shadow: var(--shadow-deep); border-color: var(--accent); }

        .c-avatar {
            width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px;
            overflow: hidden; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: 0.4s;
        }
        .card:hover .c-avatar { transform: scale(1.1); border-color: var(--accent); }
        .c-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .c-name { 
            text-align: center; font-weight: 700; font-size: 1.1rem; color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* --- 6. PROFILE MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(20px);
            z-index: 2000; display: none; overflow-y: auto;
        }
        .profile-box {
            max-width: 1000px; margin: 60px auto; background: #fff;
            border-radius: 30px; box-shadow: var(--shadow-deep);
            display: grid; grid-template-columns: 350px 1fr; min-height: 70vh;
            overflow: hidden; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from {transform:translateY(100px); opacity:0;} to {transform:translateY(0); opacity:1;} }

        .left-col { background: #FDF7F5; padding: 40px; text-align: center; border-right: 1px solid #eee; }
        .p-avatar {
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid #fff;
            box-shadow: var(--shadow-soft); margin: 0 auto 20px; object-fit: cover;
        }
        .sub-imgs { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .sub-img { 
            width: 100%; height: 140px; border-radius: 12px; object-fit: cover; 
            border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .sub-img:hover { transform: scale(1.05); }

        .right-col { padding: 50px; }
        .p-name { font-family: 'Cinzel', serif; font-size: 3rem; color: var(--accent-dark); margin-bottom: 10px; }
        .p-quote { font-style: italic; color: #999; margin-bottom: 30px; display: block; }
        .notebook {
            width: 100%; min-height: 300px; padding: 0 10px;
            background-image: linear-gradient(#e5e5e5 1px, transparent 1px);
            background-size: 100% 2em; line-height: 2em; border: none; color: #555; font-size: 1.1rem;
        }
        .close-btn {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            border-radius: 50%; background: #f0f0f0; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .close-btn:hover { background: var(--accent); color: white; }

        /* --- 7. ADMIN --- */
        .edit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none;
            align-items: center; justify-content: center; color: white;
            font-size: 1.5rem; cursor: pointer; transition: 0.2s;
        }
        .del-btn, .add-btn { display: none; }
        
        body.is-admin [contenteditable="false"] { border: 1px dashed var(--accent); background: rgba(255,255,0,0.05); cursor: text; }
        body.is-admin .p-avatar-wrapper:hover .edit-overlay, 
        body.is-admin .class-frame:hover .edit-overlay,
        body.is-admin .polaroid:hover .edit-overlay { display: flex; }
        body.is-admin .del-btn, body.is-admin .add-btn { display: block; }
        
        .del-btn { position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; background: red; color: white; border-radius: 50%; border: none; cursor: pointer; }
        .add-btn { width: 100%; padding: 10px; border: 2px dashed var(--accent); margin-top: 10px; background: none; color: var(--accent); font-weight: bold; cursor: pointer; border-radius: 10px; }

        .admin-toggle {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: #333; border-radius: 50%; color: white; display: flex; align-items: center;
            justify-content: center; cursor: pointer; z-index: 5000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: 0.3s; font-size: 1.5rem; border: 2px solid white;
        }
        .admin-toggle.active { background: #27ae60; transform: rotate(90deg); }

        .login-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:6000; }
        .login-box { background:white; padding:40px; border-radius: 20px; text-align:center; }
        .login-input { padding:10px; border:1px solid #ddd; border-radius:5px; margin:15px 0; width: 200px; text-align: center; }

        /* Hearts BG */
        .hearts-container { position: fixed; width: 100%; height: 100%; top:0; left:0; pointer-events: none; z-index: -1; }
        .heart { position: absolute; bottom: -50px; animation: float 8s linear forwards; font-size: 20px; color: var(--accent); opacity: 0.6; }
        @keyframes float { to { transform: translateY(-110vh) rotate(360deg); opacity: 0; } }

        /* Small responsive tweaks */
        @media(max-width:900px){
            .memories-grid{grid-template-columns:1fr; padding:0 12px}
            .chat-section{flex-direction:column; align-items:stretch}
            .chat-inputs{width:100%}
            .class-frame{height:260px}
        }
    </style>
</head>
<body>

    <div class="overlay-bg"></div>
    <div class="hearts-container" id="hearts"></div>

    <header class="animate-up">
        <h1 id="clsTitle" contenteditable="false">K·ª∑ Y·∫øu 12A1</h1>
        <div style="margin-top:10px">
            <button class="bg-btn" onclick="clickUpload('bgInput')">üñºÔ∏è ƒê·ªïi H√¨nh N·ªÅn</button>
            <input type="file" id="bgInput" hidden accept="image/*" onchange="changeBg(this)">
            <!-- User login button (NEW) -->
            <button id="userBtn" style="margin-left:12px;padding:8px 16px;border-radius:20px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer" onclick="openUserLogin()">ƒêƒÉng nh·∫≠p</button>
            <span id="userBadge" style="margin-left:10px;color:#444;font-weight:700;"></span>
        </div>

        <div class="class-frame" style="margin-top:18px">
            <img id="mainPhoto" src="https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=1200">
            <div class="edit-overlay" onclick="clickUpload('mainInput')">üì∑ Thay ·∫¢nh</div>
            <input type="file" id="mainInput" hidden accept="image/*" onchange="changeMain(this)">
        </div>
    </header>

    <div class="memories-grid animate-up" style="animation-delay: 0.2s;">
        <div class="polaroids">
            <div class="polaroid">
                <img id="mImg1" src="https://images.unsplash.com/photo-1523580494863-6f3031224c94?w=400">
                <div class="edit-overlay" onclick="clickUpload('mi1')">‚úèÔ∏è</div>
                <input type="file" id="mi1" hidden onchange="changeMem(this,0)">
            </div>
            <div class="polaroid">
                <img id="mImg2" src="https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400">
                <div class="edit-overlay" onclick="clickUpload('mi2')">‚úèÔ∏è</div>
                <input type="file" id="mi2" hidden onchange="changeMem(this,1)">
            </div>
            <div class="polaroid">
                <img id="mImg3" src="https://images.unsplash.com/photo-1491438590914-bc09fcaaf77a?w=400">
                <div class="edit-overlay" onclick="clickUpload('mi3')">‚úèÔ∏è</div>
                <input type="file" id="mi3" hidden onchange="changeMem(this,2)">
            </div>
        </div>
        <div class="notes-col">
            <div id="note1" class="note" contenteditable="false">Th√¥ng b√°o: H·ªçp l·ªõp v√†o cu·ªëi tu·∫ßn...</div>
            <div id="note2" class="note" contenteditable="false">H·∫°n n·ªôp s·ªï l∆∞u b√∫t l√† ng√†y 20...</div>
            <div id="note3" class="note" contenteditable="false">T√¨m ƒë·ªì th·∫•t l·∫°c: Ai th·∫•y s√°ch To√°n t·ªõ ƒë√¢u kh√¥ng?</div>
        </div>
    </div>

    <!-- CHAT SECTION (ADDED) -->
    <div class="chat-section animate-up" style="animation-delay:0.25s;" id="chatSection">
        <div style="flex:1">
            <div class="chat-header">
                <div><strong>Khung Chat L·ªõp</strong> <span class="small" id="chatStatus">(ƒêƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i tin)</span></div>
                <div style="font-size:13px;color:#666">Tin nh·∫Øn l∆∞u tr√™n m√°y (localStorage)</div>
            </div>
            <div class="chat-window" id="chatWindow"></div>
        </div>
        <div class="chat-inputs">
            <textarea id="chatInput" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="4"></textarea>
            <button id="sendBtn" class="send-btn">G·ª≠i</button>
            <button id="logoutBtn" class="send-btn" style="background:#bbb;margin-top:6px;display:none">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div class="search-bar-container animate-up" style="animation-delay: 0.3s;">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m t√™n th√†nh vi√™n trong l·ªõp..." onkeyup="filterStudents()">
    </div>

    <div class="grid" id="grid"></div>

    <div class="modal" id="profileModal">
        <div class="profile-box">
            <div class="close-btn" onclick="closeModal()">√ó</div>
            <div class="left-col">
                <div style="position: relative;" class="p-avatar-wrapper">
                    <img id="pAvatar" class="p-avatar" src="">
                    <div class="edit-overlay" style="border-radius: 50%;" onclick="clickUpload('avaInput')">üì∑</div>
                    <input type="file" id="avaInput" hidden accept="image/*" onchange="changeAvatar(this)">
                </div>
                <div class="sub-imgs" id="subList"></div>
                <button class="add-btn" onclick="clickUpload('subInput')">+ ·∫¢nh K·ª∑ Ni·ªám</button>
                <input type="file" id="subInput" hidden accept="image/*" onchange="addSub(this)">
            </div>
            <div class="right-col">
                <div id="pName" class="p-name" contenteditable="false">T√™n</div>
                <div id="pQuote" class="p-quote" contenteditable="false">Quote</div>
                <div style="font-weight:bold; margin-top:20px; color:var(--accent)">üìñ D√≤ng L∆∞u B√∫t:</div>
                <div id="pNote" class="notebook" contenteditable="false">Vi·∫øt v√†o ƒë√¢y...</div>
            </div>
        </div>
    </div>

    <div class="admin-toggle" id="adminBtn" onclick="loginToggle()">‚öôÔ∏è</div>
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h3>Admin Login</h3>
            <input type="password" id="passInput" class="login-input" placeholder="admin123">
            <br>
            <button onclick="login()" style="padding:10px 30px; background:var(--accent); color:white; border:none; border-radius:20px; cursor:pointer">V√†o</button>
            <div style="margin-top:10px; color:#999; cursor:pointer" onclick="closeLogin()">H·ªßy</div>
        </div>
    </div>

    <!-- USER LOGIN MODAL (NEW) -->
    <div class="login-modal" id="userLoginModal" style="z-index:6500">
      <div class="login-box">
        <h3>ƒêƒÉng nh·∫≠p ng∆∞·ªùi d√πng</h3>
        <input type="text" id="userLoginName" class="login-input" placeholder="T√™n t√†i kho·∫£n (vd: mahoang)">
        <input type="password" id="userLoginPass" class="login-input" placeholder="M·∫≠t kh·∫©u (vd: 123123)">
        <br>
        <button onclick="userLogin()" style="padding:10px 30px; background:#6abf8f; color:white; border:none; border-radius:20px; cursor:pointer">ƒêƒÉng nh·∫≠p</button>
        <div style="margin-top:10px; color:#999; cursor:pointer" onclick="closeUserLogin()">H·ªßy</div>
        <div style="margin-top:8px;color:#666;font-size:13px">T√†i kho·∫£n m·∫´u: <strong>mahoang</strong> / m·∫≠t kh·∫©u: <strong>123123</strong> (hi·ªÉn th·ªã: Ho√†ng)</div>
      </div>
    </div>

    <script>
        const PASS = "admin123";
        let isAdmin = false, curId = 0;

        // CHAT: storage keys & test user
        const CHAT_KEY = 'yearbook_chat_v13';
        const SESSION_KEY = 'yearbook_session_v13';
        const USERS = [
          { username: 'mahoang', password: '123123', display: 'Ho√†ng' }
        ];
        let currentUser = JSON.parse(localStorage.getItem(SESSION_KEY)) || null;

        const defData = {
            title: "K·ª∑ Y·∫øu 12A1", bg: "", main: "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=1200",
            memImgs: ["https://images.unsplash.com/photo-1523580494863-6f3031224c94?w=400", "https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=400", "https://images.unsplash.com/photo-1491438590914-bc09fcaaf77a?w=400"],
            notes: ["Th√¥ng b√°o...", "H·∫°n n·ªôp...", "T√¨m ƒë·ªì..."],
            students: new Array(50).fill(null).map((_,i)=>({
                name: `H·ªçc Sinh ${i+1}`, quote: "Ch∆∞a c√≥ tr√≠ch d·∫´n", note: "Ch∆∞a c√≥ l∆∞u b√∫t...",
                avatar: "https://i.pinimg.com/originals/f1/0f/7b/f10f7b59f3d5ea31500908728362635c.jpg", subs: []
            }))
        };

        let db = JSON.parse(localStorage.getItem('yearbook_v13')) || defData;
        let chatStore = JSON.parse(localStorage.getItem(CHAT_KEY)) || [];

        window.onload = () => { initHearts(); render(); applyBg(); renderChat(); updateUserUI(); };
        function save() { localStorage.setItem('yearbook_v13', JSON.stringify(db)); }
        function saveChat(){ localStorage.setItem(CHAT_KEY, JSON.stringify(chatStore)); }

        function render() {
            document.getElementById('clsTitle').innerText = db.title;
            document.getElementById('mainPhoto').src = db.main;
            for(let i=0; i<3; i++) {
                document.getElementById(`mImg${i+1}`).src = db.memImgs[i];
                document.getElementById(`note${i+1}`).innerText = db.notes[i];
            }
            
            const g = document.getElementById('grid'); g.innerHTML = '';
            db.students.forEach((s, i) => {
                g.innerHTML += `
                    <div class="card animate-up" style="animation-delay: ${i*0.05}s" onclick="openProfile(${i})">
                        <div class="c-avatar"><img src="${s.avatar}"></div>
                        <div class="c-name">${s.name}</div>
                    </div>`;
            });
        }

        // --- T√åM KI·∫æM ---
        function filterStudents() {
            const input = document.getElementById('searchInput');
            const filter = removeVietnameseTones(input.value.toLowerCase());
            const grid = document.getElementById('grid');
            const cards = grid.getElementsByClassName('card');

            for (let i = 0; i < cards.length; i++) {
                const nameDiv = cards[i].getElementsByClassName('c-name')[0];
                if (nameDiv) {
                    const txtValue = removeVietnameseTones(nameDiv.textContent || nameDiv.innerText).toLowerCase();
                    if (txtValue.indexOf(filter) > -1) {
                        cards[i].style.display = "";
                    } else {
                        cards[i].style.display = "none";
                    }
                }
            }
        }

        // H√†m x·ª≠ l√Ω ti·∫øng Vi·ªát (ƒë·ªÉ g√µ 'hien' v·∫´n ra 'Hi·ªÅn')
        function removeVietnameseTones(str) {
            str = str.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"); 
            str = str.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"); 
            str = str.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"); 
            str = str.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"); 
            str = str.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"); 
            str = str.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"); 
            str = str.replace(/ƒë/g,"d");
            str = str.replace(/√Ä|√Å|·∫†|·∫¢|√É|√Ç|·∫¶|·∫§|·∫¨|·∫®|·∫™|ƒÇ|·∫∞|·∫Æ|·∫∂|·∫≤|·∫¥/g, "A");
            str = str.replace(/√à|√â|·∫∏|·∫∫|·∫º|√ä|·ªÄ|·∫æ|·ªÜ|·ªÇ|·ªÑ/g, "E");
            str = str.replace(/√å|√ç|·ªä|·ªà|ƒ®/g, "I");
            str = str.replace(/√í|√ì|·ªå|·ªé|√ï|√î|·ªí|·ªê|·ªò|·ªî|·ªñ|∆†|·ªú|·ªö|·ª¢|·ªû|·ª†/g, "O");
            str = str.replace(/√ô|√ö|·ª§|·ª¶|≈®|∆Ø|·ª™|·ª®|·ª∞|·ª¨|·ªÆ/g, "U");
            str = str.replace(/·ª≤|√ù|·ª¥|·ª∂|·ª∏/g, "Y");
            str = str.replace(/ƒê/g, "D");
            return str;
        }

        function applyBg() { if(db.bg) document.body.style.backgroundImage = `url('${db.bg}')`; }

        function openProfile(i) {
            curId = i; const s = db.students[i];
            document.getElementById('pAvatar').src = s.avatar;
            document.getElementById('pName').innerText = s.name;
            document.getElementById('pQuote').innerText = s.quote;
            document.getElementById('pNote').innerText = s.note;
            renderSubs(); updateEdit();
            document.getElementById('profileModal').style.display = 'block';
        }
        function renderSubs() {
            const c = document.getElementById('subList'); c.innerHTML = '';
            db.students[curId].subs.forEach((src, idx) => {
                c.innerHTML += `<div style="position:relative"><img class="sub-img" src="${src}"><button class="del-btn" onclick="delSub(${idx})">√ó</button></div>`;
            });
        }
        function closeModal() { document.getElementById('profileModal').style.display='none'; render(); }

        function clickUpload(id) { if(isAdmin) document.getElementById(id).click(); }
        function read(inp, cb) { if(inp.files[0]){ const r=new FileReader(); r.onload=e=>cb(e.target.result); r.readAsDataURL(inp.files[0]); } }
        
        function changeBg(i) { read(i, r=>{ db.bg=r; applyBg(); save(); }); }
        function changeMain(i) { read(i, r=>{ db.main=r; render(); save(); }); }
        function changeMem(i, idx) { read(i, r=>{ db.memImgs[idx]=r; render(); save(); }); }
        function changeAvatar(i) { read(i, r=>{ db.students[curId].avatar=r; document.getElementById('pAvatar').src=r; save(); }); }
        function addSub(i) { read(i, r=>{ if(db.students[curId].subs.length<10){ db.students[curId].subs.push(r); renderSubs(); save(); } else alert("Max 10!"); }); }
        window.delSub = (idx) => { if(confirm("X√≥a?")){ db.students[curId].subs.splice(idx,1); renderSubs(); save(); } }

        ['clsTitle', 'note1', 'note2', 'note3', 'pName', 'pQuote', 'pNote'].forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('blur', function() {
                if(!isAdmin) return;
                const val = this.innerText;
                if(id==='clsTitle') db.title = val;
                else if(id.includes('note') && id.length===5) db.notes[parseInt(id.replace('note',''))-1] = val;
                else {
                    let k = id.replace('p','').toLowerCase(); if(k==='name') k='name';
                    db.students[curId][k] = val;
                }
                save();
            });
        });

        function loginToggle() { if(isAdmin){ isAdmin=false; updateUI(); } else document.getElementById('loginModal').style.display='flex'; }
        function closeLogin() { document.getElementById('loginModal').style.display='none'; }
        function login() { 
            if(document.getElementById('passInput').value === PASS) { isAdmin=true; closeLogin(); updateUI(); } 
            else alert("Sai m·∫≠t kh·∫©u"); 
        }
        function updateUI() {
            const btn = document.getElementById('adminBtn');
            if(isAdmin) { document.body.classList.add('is-admin'); btn.classList.add('active'); }
            else { document.body.classList.remove('is-admin'); btn.classList.remove('active'); }
            updateEdit();
        }
        function updateEdit() {
            ['clsTitle', 'note1', 'note2', 'note3', 'pName', 'pQuote', 'pNote'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.contentEditable = isAdmin;
            });
            // show/hide edit overlays via existing CSS (body.is-admin)
        }

        // USER LOGIN (for chat)
        function openUserLogin(){ document.getElementById('userLoginModal').style.display='flex'; }
        function closeUserLogin(){ document.getElementById('userLoginModal').style.display='none'; }
        function userLogin(){
            const u = document.getElementById('userLoginName').value.trim();
            const p = document.getElementById('userLoginPass').value;
            const found = USERS.find(x => x.username === u && x.password === p);
            if(found){
                currentUser = { username: found.username, display: found.display };
                localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                updateUserUI();
                closeUserLogin();
                alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng l√†: ' + found.display);
            } else {
                alert('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u');
            }
        }
        function logoutUser(){
            currentUser = null; localStorage.removeItem(SESSION_KEY); updateUserUI();
        }
        function updateUserUI(){
            const badge = document.getElementById('userBadge');
            const status = document.getElementById('chatStatus');
            const logoutBtn = document.getElementById('logoutBtn');
            if(currentUser){
                badge.innerText = 'Xin ch√†o, ' + currentUser.display;
                status.innerText = '(B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p)';
                logoutBtn.style.display = 'block';
            } else {
                badge.innerText = '';
                status.innerText = '(ƒêƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i tin)';
                logoutBtn.style.display = 'none';
            }
        }
        document.getElementById('logoutBtn').addEventListener('click', ()=>{ if(confirm('ƒêƒÉng xu·∫•t?')) logoutUser(); });

        // CHAT: rendering & sending
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        function renderChat(){
            chatWindow.innerHTML = '';
            chatStore.forEach(msg=>{
                const wrap = document.createElement('div');
                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.innerText = `${msg.display || msg.username} ‚Ä¢ ${new Date(msg.t).toLocaleString()}`;
                const bubble = document.createElement('div');
                bubble.className = 'message' + (currentUser && currentUser.username === msg.username ? ' me' : '');
                bubble.innerText = msg.text;
                wrap.appendChild(meta);
                wrap.appendChild(bubble);
                chatWindow.appendChild(wrap);
            });
            // scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

        function sendMessage(){
            const text = chatInput.value.trim();
            if(!text) return;
            if(!currentUser){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i tin. Nh·∫•n "ƒêƒÉng nh·∫≠p".'); return; }
            const msg = { username: currentUser.username, display: currentUser.display, text, t: Date.now() };
            chatStore.push(msg);
            saveChat();
            renderChat();
            chatInput.value = '';
        }

        // --- Existing helpers & chat init ---
        function initHearts() {
            setInterval(() => {
                const h = document.createElement('div'); h.className='heart'; h.innerText='‚ù§';
                h.style.left = Math.random()*100+'vw'; 
                document.getElementById('hearts').appendChild(h);
                setTimeout(()=>h.remove(),8000);
            }, 500);
        }

        // keep previous functions connected
        document.getElementById('passInput').addEventListener('keypress', e=>{if(e.key==='Enter') login()});
        document.getElementById('userLoginPass').addEventListener('keypress', e=>{ if(e.key==='Enter') userLogin(); });

        // open user session from storage on load
        (function restoreSession(){
            const s = localStorage.getItem(SESSION_KEY);
            if(s){
                try{ currentUser = JSON.parse(s); }catch(e){ currentUser=null; }
            }
        })();

        // initial rendering of chat
        renderChat();
        updateUserUI();

    </script>
</body>
</html>
